@using Web_Hutech_Gear.Models.EF
@using Web_Hutech_Gear.Models

@model News
@{
    ViewBag.Title = "Chi Tiết Tin Tức";
    Layout = "~/Views/Shared/_Layout.cshtml";

    int idCurrent = ViewBag.idCurrent;
    int first = 0 ;
    int last = 0;
    int idMax = ViewBag.idMaxTmp;

    ApplicationDbContext db = new ApplicationDbContext();

    // Tìm id phía trước trong danh sách
    for (int i = idCurrent - 1; i >= 1; i--)
    {
        if (db.News.Any(x => x.Id == i))
        {
            first = i;
            break;
        }
    }

    // Tìm id phía sau trong danh sách
    for (int i = idCurrent + 1; i <= idMax; i++)
    {
        if (db.News.Any(x => x.Id == i))
        {
            last = i;
            break;
        }
    }

    if (0 >= first)
    {
        first = 0;
    }
    if (ViewBag.idMaxTmp < last)
    {
        last = 0;
    }
    IEnumerable<Comment> listComment = ViewBag.listComment as IEnumerable<Comment>;
}

<div id="inner_banner" class="section inner_banner_section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="full">
                    <div class="title-holder">
                        <div class="title-holder-cell text-left">
                            <h1 class="page-title">Chi Tiết Tin Tức</h1>
                            <ol class="breadcrumb">
                                <li><a href="index.html">Home</a></li>
                                <li class="active">Trang Chi Tiết (@Model.Title)</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end inner page banner -->
<!-- section -->
<div class="section padding_layout_1 blog_grid">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-8 col-sm-12 col-xs-12 news-list">
                <div class="full">
                    <div class="blog_section margin_bottom_0">
                        <div class="blog_feature_img"> <img class="img-responsive" src="@Model.Image" alt="@Model.Title"> </div>
                        <div class="blog_feature_cantant">
                            <p class="blog_head">@Model.Title</p>
                            <div class="post_info">
                                <ul>
                                    @if (string.IsNullOrEmpty(Model.CreatedBy))
                                    {
                                        <li><i class="fa fa-user" aria-hidden="true"></i> Admin</li>
                                    }
                                    else
                                    {
                                        <li><i class="fa fa-user" aria-hidden="true"></i> @Model.CreatedBy</li>
                                    }
                                    @*<li><i class="fa fa-comment" aria-hidden="true"></i> 5</li>*@
                                    <li><i class="fa fa-calendar" aria-hidden="true"></i>@string.Format("{0:dd/MM/yyyy}", Model.CreatedDate)</li>
                                </ul>
                            </div>
                            <p>@Html.Raw(Model.Detail)</p>
                        </div>


                        <div class="comment_section">
                            @if (first != 0)
                            {
                                <div class="pull-left text_align_left">
                                    <div class="full">
                                        <div class="preview_commt">
                                            <a class="comment_cantrol preview_commat" href="/News/DetailNew?id=@first">
                                                <span>
                                                    <i class="fa fa-angle-left"></i>
                                                    <i class="fa fa-angle-left"></i>
                                                    Bài Trước
                                                </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (last != 0)
                            {
                                <div class="pull-right text_align_right">
                                    <div class="full">
                                        <div class="next_commt">
                                            <a class="comment_cantrol preview_commat" href="/News/DetailNew?id=@last">
                                                <span>
                                                    Tiếp Theo
                                                    <i class="fa fa-angle-right"></i>
                                                    <i class="fa fa-angle-right"></i>
                                                </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        <br />
                        <div class="view_commant">
                            <div class="row">
                                <div class="col-lg-10 col-md-10 col-sm-9 col-xs-12">
                                    <div class="comment-section-news">
                                        @Html.Partial("Partial_Comment", listComment)
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="post_commt_form">
                            <div class="form_section">
                                @if (Request.IsAuthenticated)
                                {
                                    <form class="comment-form-news" action="@Url.Action("Comment", "News", new { strURL = Request.Url.ToString() })" method="post">
                                        <h4 style="padding-bottom:10px">Bình Luận Bài Viết</h4>
                                        <fieldset class="row">
                                            <div class="field col-lg-4 col-md-4 col-sm-6 col-xs-12" style="display:none">
                                                <input class="field_custom" name="newsId" value="@Model.Id" type="text" required>
                                            </div>
                                            <div class="field col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                                <textarea name="content" class="field_custom cmt" placeholder="Nhập bình luận" required></textarea>
                                            </div>
                                            <div class="center">
                                                <button class="btn main_bt" type="submit">Bình Luận</button>
                                            </div>
                                        </fieldset>
                                    </form>
                                }
                                else
                                {
                                    <a href="/Account/Login">Đăng Nhập Để Bình Luận</a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- end section -->
<!-- Modal -->
<!-- End Model search bar -->
@section scripts{
    <!--Ajax cho việc bình luận-->
    <script>
        $(function () {
            // Sử dụng jQuery để bắt sự kiện khi người dùng submit form
            $('.comment-form-news').on('submit', function (e) {
                e.preventDefault(); // Ngăn chặn submit form mặc định
                var form = $(this);
                var url = form.attr('action'); // Lấy URL của controller action
                var method = form.attr('method'); // Lấy HTTP method (GET hoặc POST)
                // Sử dụng jQuery AJAX để gửi dữ liệu form đến controller action
                $.ajax({
                    url: url,
                    type: method,
                    data: form.serialize(), // Chuyển đổi dữ liệu form thành chuỗi URL-encoded
                    success: function (result) {
                        // Nếu controller action trả về kết quả thành công, cập nhật phần tử HTML chứa dữ liệu
                        $('.comment-section-news').html(result);
                        form.find('.cmt').val('');
                    }
                });
            });
        });
    </script>

}